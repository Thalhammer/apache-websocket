.PHONY: install clean check start restart stop examples install-examples

# Paths to tools (set by configure)
APXS := @APXS@
APACHECTL := @APACHECTL@

# CFLAGS and LDFLAGS can be set during the make invocation.
CFLAGS += -g -Wall
LDFLAGS +=

# Flags for all compilation.
comma := ,
APXS_CFLAGS := $(addprefix -Wc$(comma),$(CFLAGS))
APXS_LDFLAGS := $(addprefix -Wl$(comma),$(LDFLAGS))

# List of headers we depend on.
HEADERS := websocket_plugin.h

# List of example plugins -- one for each *.c in the examples/ directory.
EXAMPLES := $(wildcard examples/*.c)
EXAMPLE_PLUGINS := $(patsubst %.c,%.la,$(EXAMPLES))
EXAMPLE_NAMES := $(basename $(notdir $(EXAMPLES)))
EXAMPLE_INSTALLS := $(addprefix install-,$(EXAMPLE_NAMES))
.PHONY: $(EXAMPLE_INSTALLS)

#
# Rules
#

all: mod_websocket.la examples

install: mod_websocket.la
	$(APXS) -i $<

clean:
	rm -f *.lo *.la *.slo *.o
	rm -rf .libs/
	rm -f examples/*.lo examples/*.la examples/*.slo examples/*.o
	rm -rf examples/.libs/

check:
	$(MAKE) -C test/ test

start restart stop:
	$(APACHECTL) $@

examples: $(EXAMPLE_PLUGINS)

install-examples: $(EXAMPLE_INSTALLS)

# Note that to work around PR43033, we have to pass an -n option even though we
# are not 'activating' the example plugins.
$(EXAMPLE_INSTALLS): install-%: examples/%.la
	$(APXS) -i -n unused $<

# The main module has an additional header dependency.
mod_websocket.la: HEADERS += validate_utf8.h

# Secondary expansion lets us modify the prerequisite HEADERS at runtime.
.SECONDEXPANSION:
%.la: %.c $$(HEADERS)
	$(APXS) -c -I. $(APXS_CFLAGS) $(APXS_LDFLAGS) $<
